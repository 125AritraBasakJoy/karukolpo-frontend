<div class="inventory-container p-4 min-h-screen">
    <div class="header-section mb-5">
        <div class="flex flex-column sm:flex-row sm:align-items-center justify-content-between gap-3">
            <div>
                <h1 class="page-title m-0 mb-1">Inventory Management</h1>
                <p class="text-slate-400 m-0 text-sm">Track stock levels and monitor product performance.</p>
            </div>
            <div class="flex gap-2 flex-shrink-0">
                <app-notification-button></app-notification-button>
                <p-button icon="pi pi-refresh" (onClick)="refreshProducts()" styleClass="premium-btn-primary"
                    pTooltip="Refresh Inventory" tooltipPosition="bottom"></p-button>
            </div>
        </div>
    </div>

    <!-- Sales Summary Cards - 2 columns on mobile, 4 on desktop -->
    <div class="stats-grid mb-5">
        <div class="stat-card glass-card">
            <div class="stats-icon-circle orange">
                <i class="pi pi-box"></i>
            </div>
            <span class="stat-label">Total Products</span>
            <h2 class="stat-value">{{ totalRecords() | number }}</h2>
        </div>

        <div class="stat-card glass-card">
            <div class="stats-icon-circle blue">
                <i class="pi pi-shopping-bag"></i>
            </div>
            <span class="stat-label">Units Sold</span>
            <h2 class="stat-value">{{ totalUnitsSold() | number }}</h2>
        </div>

        <div class="stat-card glass-card">
            <div class="stats-icon-circle green">
                <i class="pi pi-wallet"></i>
            </div>
            <span class="stat-label">Total Revenue</span>
            <h2 class="stat-value revenue">{{ totalRevenue() | currency:'BDT':'symbol-narrow':'1.0-0' }}</h2>
        </div>

        <div class="stat-card glass-card">
            <div class="stats-icon-circle purple">
                <i class="pi pi-check-circle"></i>
            </div>
            <span class="stat-label">Completed Orders</span>
            <h2 class="stat-value">{{ confirmedOrdersCount() | number }}</h2>
        </div>
    </div>

    <div class="grid mb-5">
        <div class="col-12">
            <div class="chart-section-card">
                <div class="chart-header">
                    <div class="chart-icon">
                        <i class="pi pi-chart-bar"></i>
                    </div>
                    <h3>Product Sales Performance</h3>
                </div>
                <div *ngIf="chartData; else loadingChart" class="chart-wrapper">
                    <p-chart type="bar" [data]="chartData" [options]="chartOptions" height="250"></p-chart>
                </div>
                <ng-template #loadingChart>
                    <div class="flex align-items-center justify-content-center" style="height: 200px">
                        <p-progressSpinner styleClass="w-3rem h-3rem"></p-progressSpinner>
                    </div>
                </ng-template>
            </div>
        </div>
    </div>

    <div class="glass-card fadein animation-duration-500">
        <p-table #dt [value]="products()" [rows]="10" [paginator]="true" [globalFilterFields]="['name', 'id', 'code']"
            [rowsPerPageOptions]="[10, 25, 50, 100]" [tableStyle]="{'min-width': '60rem'}" styleClass="premium-table-v2"
            [rowHover]="true" [loading]="loading()" [showCurrentPageReport]="true"
            currentPageReportTemplate="Showing {first} to {last} of many (Buffered)" [lazy]="true"
            (onLazyLoad)="loadProducts($event)" [totalRecords]="totalRecords()">

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="id" style="width: 120px">ID <p-sortIcon field="id"></p-sortIcon></th>
                    <th pSortableColumn="name" style="min-width: 15rem">Product Name <p-sortIcon
                            field="name"></p-sortIcon></th>
                    <th>Image</th>
                    <th pSortableColumn="price">Price <p-sortIcon field="price"></p-sortIcon></th>
                    <th pSortableColumn="stock">Status <p-sortIcon field="stock"></p-sortIcon></th>
                    <th class="text-right">Actions</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-product>
                <tr class="table-row">
                    <td>
                        <code class="id-tag">#{{ product.id }}</code>
                    </td>
                    <td>
                        <span class="font-semibold text-white">{{ product.name }}</span>
                    </td>
                    <td>
                        <div class="product-img-container">
                            <img [src]="product.imageUrl" [alt]="product.name" class="product-img" loading="lazy" />
                        </div>
                    </td>
                    <td>
                        <span class="price-value font-medium">{{ product.price | currency:'BDT':'symbol-narrow'
                            }}</span>
                    </td>
                    <td>
                        <div class="status-badge-container">
                            <p-tag [value]="product.manualStockStatus === 'IN_STOCK' ? 'In Stock (Forced)' : 
                                           (product.manualStockStatus === 'OUT_OF_STOCK' ? 'Out of Stock (Forced)' : 
                                           (product.stock > 0 ? 'In Stock (' + product.stock + ')' : 'Out of Stock'))"
                                [severity]="product.manualStockStatus === 'IN_STOCK' ? 'success' : 
                                               (product.manualStockStatus === 'OUT_OF_STOCK' ? 'danger' : 
                                               (product.stock > 0 ? 'success' : 'danger'))"
                                styleClass="custom-stock-tag"></p-tag>
                        </div>
                    </td>
                    <td class="text-right">
                        <div class="flex justify-content-end gap-2">
                            <button pButton pRipple icon="pi pi-box"
                                class="p-button-rounded p-button-text action-btn info-btn"
                                (click)="manageInventory(product)" pTooltip="Manage Inventory"
                                tooltipPosition="top"></button>
                            <button pButton pRipple icon="pi pi-pencil"
                                class="p-button-rounded p-button-text action-btn success-btn"
                                (click)="editProduct(product)" pTooltip="Edit Product" tooltipPosition="top"></button>
                            <button pButton pRipple icon="pi pi-trash"
                                class="p-button-rounded p-button-text action-btn danger-btn"
                                (click)="deleteProduct(product)" pTooltip="Delete Product" tooltipPosition="top"
                                [disabled]="true"></button>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>

        <!-- Skeleton for loading state -->
        <p-table [value]="[1,2,3,4,5,6]" *ngIf="loading()" styleClass="premium-table-v2">
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 120px">ID</th>
                    <th style="min-width: 15rem">Product Name</th>
                    <th>Image</th>
                    <th>Price</th>
                    <th>Status</th>
                    <th class="text-right">Actions</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body">
                <tr>
                    <td><p-skeleton width="60px"></p-skeleton></td>
                    <td><p-skeleton width="150px"></p-skeleton></td>
                    <td><p-skeleton width="50px" height="50px" borderRadius="12px"></p-skeleton></td>
                    <td><p-skeleton width="80px"></p-skeleton></td>
                    <td><p-skeleton width="100px" height="24px" borderRadius="20px"></p-skeleton></td>
                    <td class="text-right"><p-skeleton width="100px" height="32px"></p-skeleton></td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<!-- Step 1: Basic Details Dialog -->
<p-dialog [(visible)]="displayStep1" [style]=" { width: '450px' } " header="Step 1: Basic Details" [modal]="true"
    styleClass="premium-dialog" appendTo="body">
    <ng-template pTemplate="content">
        <div class="field">
            <label for="name">Name</label>
            <input type="text" pInputText id="name" [(ngModel)]="productForm.name" #name="ngModel" required autofocus
                class="w-full premium-input" />
            <app-validation-message [control]="name.control"></app-validation-message>
        </div>
        <div class="field">
            <label for="description">Description</label>
            <p-editor id="description" [(ngModel)]="productForm.description" [style]="{'height': '160px'}"
                styleClass="premium-editor w-full">
                <ng-template pTemplate="header">
                    <span class="ql-formats">
                        <button class="ql-bold" title="Bold"></button>
                        <button class="ql-italic" title="Italic"></button>
                        <button class="ql-underline" title="Underline"></button>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-list" value="ordered" title="Ordered List"></button>
                        <button class="ql-list" value="bullet" title="Bullet List"></button>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-link" title="Link"></button>
                        <button class="ql-clean" title="Remove Formatting"></button>
                    </span>
                </ng-template>
            </p-editor>
        </div>
        <div class="field">
            <label for="price">Price</label>
            <p-inputNumber id="price" [(ngModel)]="productForm.price" #price="ngModel" required mode="currency"
                currency="BDT" locale="en-US" styleClass="w-full" inputStyleClass="w-full premium-input"
                [style]="{'width':'100%'}"></p-inputNumber>
            <app-validation-message [control]="price.control"></app-validation-message>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-end gap-2 px-3 pb-3">
            <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text p-button-secondary"
                (click)="displayStep1 = false"></button>
            <button pButton pRipple label="Next" icon="pi pi-arrow-right" class="premium-btn-primary px-4"
                (click)="saveProductStep1()"></button>
        </div>
    </ng-template>
</p-dialog>

<!-- Step 2: Media & Category Dialog -->
<p-dialog [(visible)]="displayStep2" [style]=" { width: '450px' } " header="Step 2: Category & Images" [modal]="true"
    styleClass="premium-dialog" appendTo="body">
    <ng-template pTemplate="content">
        <div class="field">
            <label for="category">Category</label>
            <p-dropdown id="category" [options]="categories()" optionLabel="name" optionValue="id"
                [(ngModel)]="productForm.categoryId" placeholder="Select a Category" [showClear]="true"
                [editable]="true" [filter]="true" filterBy="name" styleClass="w-full" [style]="{'width':'100%'}"
                [panelStyle]="{'width':'100%'}" panelStyleClass="w-full" appendTo="body"></p-dropdown>
        </div>

        <div class="field" *ngIf="!isNewProduct && existingImages.length > 0">
            <label class="block mb-2 text-primary font-medium">Existing Images</label>
            <div class="flex flex-wrap gap-3 mt-2">
                <div *ngFor="let img of existingImages" class="relative p-2 border-round transition-all"
                    [ngClass]="{'border-primary border-2 bg-primary-reverse': isImagePrimary(img), 'surface-100': !isImagePrimary(img)}">
                    <img [src]="img.image_thumb || img.image_path"
                        class="w-6rem h-6rem border-round shadow-1 object-cover block">

                    <div class="absolute top-0 right-0 flex gap-1 p-1">
                        <button *ngIf="!isImagePrimary(img)" pButton icon="pi pi-star"
                            class="p-button-rounded p-button-success p-button-sm"
                            style="width: 2rem; height: 2rem; padding: 0" (click)="setAsPrimary(img)"
                            pTooltip="Set Primary"></button>

                        <button pButton icon="pi pi-trash" class="p-button-rounded p-button-danger p-button-sm"
                            style="width: 2rem; height: 2rem; padding: 0" (click)="removeExistingImage(img)"
                            pTooltip="Remove"></button>
                    </div>
                    <div class="absolute bottom-0 left-0 w-full text-center pb-2" *ngIf="isImagePrimary(img)">
                        <p-tag value="Primary" severity="success" styleClass="text-xs"></p-tag>
                    </div>
                </div>
            </div>
            <small class="block mt-2 text-500">Select an image to be primary or remove unused ones.</small>
        </div>

        <div class="field" *ngIf="isNewProduct">
            <label class="block mb-2">Main Product Image</label>
            <div class="flex flex-column gap-2">
                <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" class="hidden" />

                <button pButton type="button" label="Choose Main Image" icon="pi pi-image"
                    class="premium-btn-secondary w-full" (click)="fileInput.click()"></button>

                <div *ngIf="selectedMainImage && productForm.imageUrl"
                    class="surface-card p-3 border-round shadow-2 w-full text-center mt-2">
                    <img [src]="productForm.imageUrl" alt="Preview"
                        style="max-height: 200px; max-width: 100%; object-fit: contain;" loading="lazy">
                </div>
            </div>
        </div>

        <div class="field">
            <label class="block mb-2">{{ isNewProduct ? 'Additional Images (Gallery)' : 'Upload New Images' }}</label>
            <div class="flex flex-column gap-2">
                <input type="file" #additionalFilesInput (change)="onAdditionalFilesSelected($event)" accept="image/*"
                    multiple class="hidden" />

                <button pButton type="button" [label]="isNewProduct ? 'Add Additional Images' : 'Add New Images'"
                    icon="pi pi-images" class="premium-btn-secondary w-full"
                    (click)="additionalFilesInput.click()"></button>

                <div *ngIf="selectedAdditionalImages.length > 0" class="flex flex-wrap gap-2 mt-2">
                    <div *ngFor="let img of productForm.images; let i = index" class="relative">
                        <img [src]="img" class="w-8rem h-8rem border-round shadow-2 object-cover block">
                        <button pButton icon="pi pi-times"
                            class="p-button-rounded p-button-danger p-button-text absolute top-0 right-0"
                            style="background: rgba(255,255,255,0.8)" (click)="removeAdditionalImage(i)"></button>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-end gap-2 px-3 pb-3">
            <button pButton pRipple label="Next" icon="pi pi-arrow-right" class="premium-btn-primary px-4"
                (click)="saveProductStep2()"></button>
        </div>
    </ng-template>
</p-dialog>

<!-- Step 3: Inventory Management Dialog -->
<p-dialog [(visible)]="displayStep3" [style]=" { width: '450px' } " header="Step 3: Inventory" [modal]="true"
    styleClass="premium-dialog" appendTo="body">
    <ng-template pTemplate="content">
        <div class="field">
            <label for="stock">Quantity</label>
            <p-inputNumber id="stock" [(ngModel)]="inventoryForm.stock" [min]="0" mode="decimal" styleClass="w-full"
                inputStyleClass="w-full premium-input" [style]="{'width':'100%'}"></p-inputNumber>
        </div>

        <div class="field">
            <label for="manualStockStatus">Stock Availability Control</label>
            <p-dropdown id="manualStockStatus" [options]="manualStockOptions"
                [(ngModel)]="inventoryForm.manualStockStatus" placeholder="Select Stock Status" appendTo="body"
                styleClass="w-full" [style]="{'width':'100%'}"></p-dropdown>
            <small class="block mt-1 text-500">Override the automatic stock calculation if needed.</small>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-end gap-2 px-3 pb-3">
            <button pButton pRipple label="Save & Finish" icon="pi pi-check" class="premium-btn-primary px-4"
                (click)="saveInventory()"></button>
        </div>
    </ng-template>
</p-dialog>

<p-confirmDialog [style]=" { width: '450px' } " styleClass="premium-confirm-dialog" appendTo="body"></p-confirmDialog>
<p-toast></p-toast>