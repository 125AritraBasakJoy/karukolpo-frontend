<div class="card">
    <div class="flex justify-content-between align-items-center mb-4">
        <h2>Inventory Management</h2>
        <div class="flex gap-2">
            <app-notification-button></app-notification-button>
            <p-button icon="pi pi-refresh" (onClick)="refreshProducts()"
                styleClass="p-button-outlined p-button-secondary" pTooltip="Refresh Inventory"
                tooltipPosition="bottom"></p-button>
            <p-button label="New Product" icon="pi pi-plus" (onClick)="openNew()"></p-button>
        </div>
    </div>

    <div class="grid mb-4">
        <div class="col-12 lg:col-6">
            <p-card header="Product Sales Overview">
                <p-chart type="bar" [data]="chartData" [options]="chartOptions"></p-chart>
            </p-card>
        </div>
        <div class="col-12 lg:col-6">
            <p-card header="Stats">
                <div class="text-center">
                    <h3>Total Products</h3>
                    <p class="text-4xl font-bold text-primary">{{ products().length }}</p>
                </div>
            </p-card>

        </div>
    </div>

    <div *ngIf="loading()" class="mb-4">
        <p-table [value]="[1,2,3,4,5]" [tableStyle]="{ 'min-width': '50rem' }">
            <ng-template pTemplate="header">
                <tr>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Image</th>
                    <th>Price</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body">
                <tr>
                    <td><p-skeleton></p-skeleton></td>
                    <td><p-skeleton></p-skeleton></td>
                    <td><p-skeleton width="50px" height="50px"></p-skeleton></td>
                    <td><p-skeleton></p-skeleton></td>
                    <td><p-skeleton width="5rem"></p-skeleton></td>
                    <td>
                        <div class="flex gap-2">
                            <p-skeleton shape="circle" size="2rem"></p-skeleton>
                            <p-skeleton shape="circle" size="2rem"></p-skeleton>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <p-table [value]="products()" [tableStyle]="{ 'min-width': '50rem' }" *ngIf="!loading()">
        <ng-template pTemplate="header">
            <tr>
                <th>Code</th>
                <th>Name</th>
                <th>Image</th>
                <th>Price</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-product>
            <tr>
                <td>{{ product.code }}</td>
                <td>{{ product.name }}</td>
                <td><img [src]="product.imageUrl" [alt]="product.name" width="50" class="shadow-4" /></td>
                <td>{{ product.price | currency:'BDT':'symbol-narrow' }}</td>
                <td>
                    <p-tag [value]="product.manualStockStatus === 'IN_STOCK' ? 'In Stock (Forced)' : 
                                   (product.manualStockStatus === 'OUT_OF_STOCK' ? 'Out of Stock (Forced)' : 
                                   (product.stock > 0 ? 'In Stock (' + product.stock + ')' : 'Out of Stock'))"
                        [severity]="product.manualStockStatus === 'IN_STOCK' ? 'success' : 
                                       (product.manualStockStatus === 'OUT_OF_STOCK' ? 'danger' : 
                                       (product.stock > 0 ? 'success' : 'danger'))"></p-tag>
                </td>
                <td>
                    <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="success"
                        (onClick)="editProduct(product)"></p-button>
                    <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger"
                        (onClick)="deleteProduct(product)"></p-button>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<p-dialog [(visible)]="displayProductDialog" [style]="{ width: '450px' }" header="Product Details" [modal]="true"
    styleClass="p-fluid">
    <ng-template pTemplate="content">
        <div class="field">
            <label for="name">Name</label>
            <input type="text" pInputText id="name" [(ngModel)]="productForm.name" #name="ngModel" required autofocus />
            <app-validation-message [control]="name.control"></app-validation-message>
        </div>
        <div class="field">
            <label for="code">Code (Auto-generated)</label>
            <input type="text" pInputText id="code" [(ngModel)]="productForm.code" required [readonly]="true" />
        </div>
        <div class="field">
            <label for="description">Description</label>
            <textarea id="description" pInputTextarea [(ngModel)]="productForm.description" required rows="3"
                cols="20"></textarea>
        </div>
        <div class="formgrid grid">
            <div class="field col">
                <label for="price">Price</label>
                <p-inputNumber id="price" [(ngModel)]="productForm.price" #price="ngModel" required mode="currency"
                    currency="BDT" locale="en-US"></p-inputNumber>
                <app-validation-message [control]="price.control"></app-validation-message>
            </div>
            <div class="field col">
                <label for="stock">Quantity</label>
                <p-inputNumber id="stock" [(ngModel)]="productForm.stock" #stock="ngModel" [min]="0"
                    mode="decimal"></p-inputNumber>
            </div>
        </div>

        <div class="field">
            <label for="manualStockStatus">Stock Availability Control</label>
            <p-dropdown id="manualStockStatus" [options]="manualStockOptions"
                [(ngModel)]="productForm.manualStockStatus" placeholder="Select Stock Status"
                appendTo="body"></p-dropdown>
            <small class="block mt-1 text-500">Override the automatic stock calculation if needed.</small>
        </div>
        <div class="field">
            <label class="block mb-2">Product Image</label>
            <div class="flex flex-column gap-3">
                <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" class="hidden" />

                <div class="flex align-items-center gap-3">
                    <button pButton type="button" label="Choose Image" icon="pi pi-image" class="p-button-outlined"
                        (click)="fileInput.click()"></button>
                    <span *ngIf="productForm.imageUrl" class="text-green-500 font-bold"><i class="pi pi-check ml-2"></i>
                        Selected</span>
                </div>

                <div *ngIf="productForm.imageUrl" class="surface-card p-3 border-round shadow-2 w-full text-center">
                    <img [src]="productForm.imageUrl" alt="Preview"
                        style="max-height: 200px; max-width: 100%; object-fit: contain;">
                </div>
            </div>
        </div>

        <div class="field">
            <label class="block mb-2">Additional Images (Gallery)</label>
            <div class="flex flex-column gap-3">
                <input type="file" #additionalFilesInput (change)="onAdditionalFilesSelected($event)" accept="image/*"
                    multiple class="hidden" />

                <div class="flex align-items-center gap-3">
                    <button pButton type="button" label="Add More Images" icon="pi pi-images"
                        class="p-button-outlined p-button-secondary" (click)="additionalFilesInput.click()"></button>
                </div>

                <div *ngIf="productForm.images && productForm.images.length > 0" class="flex flex-wrap gap-2 mt-2">
                    <div *ngFor="let img of productForm.images; let i = index" class="relative">
                        <img [src]="img" class="w-8rem h-8rem border-round shadow-2 object-cover block">
                        <button pButton icon="pi pi-times"
                            class="p-button-rounded p-button-danger p-button-text absolute top-0 right-0"
                            style="background: rgba(255,255,255,0.8)" (click)="removeAdditionalImage(i)"></button>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" [text]="true" (onClick)="displayProductDialog = false"></p-button>
        <p-button label="Save" icon="pi pi-check" [text]="true" (onClick)="saveProduct()"></p-button>
    </ng-template>
</p-dialog>

<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>
<p-toast></p-toast>