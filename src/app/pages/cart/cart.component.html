<div class="cart-page">
    <div class="cart-container">
        <!-- Cash Memo / Order Receipt -->
        <div *ngIf="orderConfirmed" class="success-section py-6">
            <div class="surface-card border-round-xl shadow-4 p-5 mx-auto" style="max-width: 800px;">

                <!-- Header -->
                <div id="receipt-content" class="receipt-card p-5 relative">
                    <div
                        class="flex justify-content-between align-items-center border-bottom-1 border-white-alpha-10 pb-5 mb-5">
                        <div>
                            <img src="assets/invoice-logo.jpg" alt="Karukolpo Logo" height="80" class="mb-3">
                            <h1 class="text-4xl font-bold m-0 text-white tracking-tight">INVOICE</h1>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-color-secondary uppercase tracking-widest mb-1">Invoice No</div>
                            <div class="font-bold text-xl text-primary mb-3">{{ getInvoiceNo() }}</div>
                            <div class="text-xs text-color-secondary uppercase tracking-widest mb-1">Order ID</div>
                            <div class="font-bold text-lg text-white">#{{ placedOrderId }}</div>
                        </div>
                    </div>

                    <!-- Meta Info -->
                    <div class="grid mb-6">
                        <div class="col-6">
                            <div class="mb-3">
                                <span class="text-xs text-color-secondary uppercase tracking-widest">Date Issued:</span>
                                <span class="ml-2 font-semibold text-white">{{ today | date:'mediumDate' }}</span>
                            </div>
                            <div>
                                <span class="text-xs text-color-secondary uppercase tracking-widest">Order Time:</span>
                                <span class="ml-2 font-semibold text-white">{{ today | date:'shortTime' }}</span>
                            </div>
                        </div>
                        <div class="col-6 text-right">
                            <div class="mb-3">
                                <span class="text-xs text-color-secondary uppercase tracking-widest">Payment
                                    Method:</span>
                                <span class="ml-2 font-semibold text-primary">{{ orderPaymentMethod }}</span>
                            </div>
                            <div>
                                <span class="text-xs text-color-secondary uppercase tracking-widest">Payment
                                    Status:</span>
                                <span class="ml-2 font-semibold"
                                    [class.text-red-400]="orderPaymentMethod === 'Cash on Delivery'"
                                    [class.text-green-400]="orderPaymentMethod !== 'Cash on Delivery'">
                                    {{ orderPaymentMethod === 'Cash on Delivery' ? 'Unpaid' : 'Paid' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="border-top-1 border-white-alpha-10 pt-5 mb-6">
                        <div class="grid">
                            <!-- Seller Info -->
                            <div class="col-12 md:col-4 mb-4 md:mb-0">
                                <h3 class="text-xs text-primary uppercase tracking-widest mt-0 mb-3 font-bold">Seller
                                </h3>
                                <div class="text-sm line-height-3">
                                    <div class="font-bold text-white mb-1">Karukolpo</div>
                                    <div class="text-slate-400">Pathrail, Tangail-1912, Bangladesh.</div>
                                    <div class="text-slate-400">Dhaka, Bangladesh</div>
                                    <div class="text-slate-400 mt-2">Phone: 01675-718846</div>
                                    <div class="text-slate-400">Email: support@karukolpo.com</div>
                                </div>
                            </div>
                            <!-- Bill To -->
                            <div class="col-12 md:col-4 mb-4 md:mb-0">
                                <h3 class="text-xs text-primary uppercase tracking-widest mt-0 mb-3 font-bold">Bill To
                                </h3>
                                <div class="text-sm line-height-3">
                                    <div class="font-bold text-white mb-1">{{ orderFormSnapshot.fullName }}</div>
                                    <div class="text-slate-400">Phone: {{ orderFormSnapshot.phoneNumber }}</div>
                                    <div class="text-slate-400" *ngIf="orderFormSnapshot.email">Email: {{
                                        orderFormSnapshot.email }}</div>
                                </div>
                            </div>
                            <!-- Shipping Address -->
                            <div class="col-12 md:col-4">
                                <h3 class="text-xs text-primary uppercase tracking-widest mt-0 mb-3 font-bold">Shipping
                                    Address</h3>
                                <div class="text-sm line-height-3">
                                    <div class="text-white">{{ orderFormSnapshot.fullAddress }}</div>
                                    <div class="text-slate-400">{{ orderFormSnapshot.subDistrict ?
                                        orderFormSnapshot.subDistrict + ', ' : '' }}{{ orderFormSnapshot.district }}
                                    </div>
                                    <div class="text-slate-400" *ngIf="orderFormSnapshot.postalCode">Postal Code: {{
                                        orderFormSnapshot.postalCode }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div class="invoice-items-section mb-6">
                        <div class="receipt-table-container">
                            <div
                                class="grid font-bold text-xs text-color-secondary pb-3 mb-1 uppercase tracking-widest border-bottom-1 border-white-alpha-10">
                                <div class="col-5">Product Name</div>
                                <div class="col-2 text-center">Qty</div>
                                <div class="col-2 text-right">Unit Price</div>
                                <div class="col-3 text-right">Line Total</div>
                            </div>
                            <div *ngFor="let item of orderedItems"
                                class="grid align-items-center py-3 text-sm border-bottom-1 border-white-alpha-5">
                                <div class="col-5 font-medium text-white">{{ item.product.name }}</div>
                                <div class="col-2 text-center text-slate-300">{{ item.quantity }}</div>
                                <div class="col-2 text-right text-slate-300">{{ item.product.price |
                                    currency:'BDT':'symbol-narrow' }}</div>
                                <div class="col-3 text-right font-bold text-white">{{ item.product.price * item.quantity
                                    | currency:'BDT':'symbol-narrow' }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Totals -->
                    <div class="grid">
                        <div class="col-12 md:col-7 mb-4 md:mb-0">
                            <div class="text-xs text-color-secondary uppercase tracking-widest mb-3">Notes:</div>
                            <ul class="text-xs text-slate-500 m-0 p-0 list-none line-height-3">
                                <li class="mb-1">• This is a system-generated invoice.</li>
                                <li class="mb-1">• No signature required.</li>
                                <li>• For support, contact support@karukolpo.com</li>
                            </ul>

                            <!-- Seal (Placed in the blank space) -->
                            <div class="invoice-seal-container flex justify-content-start mt-4">
                                <div class="invoice-seal" [class.seal-paid]="orderPaymentMethod !== 'Cash on Delivery'"
                                    [class.seal-unpaid]="orderPaymentMethod === 'Cash on Delivery'">
                                    <span>{{ orderPaymentMethod === 'Cash on Delivery' ? 'UNPAID' : 'PAID' }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 md:col-5">
                            <div class="flex justify-content-between mb-2 text-sm">
                                <span class="text-color-secondary">Subtotal:</span>
                                <span class="font-bold text-white">{{ getOrderSubTotal() |
                                    currency:'BDT':'symbol-narrow' }}</span>
                            </div>
                            <div class="flex justify-content-between mb-2 text-sm">
                                <span class="text-color-secondary">Delivery Fee:</span>
                                <span class="font-bold text-white">{{ orderDeliveryCharge |
                                    currency:'BDT':'symbol-narrow' }}</span>
                            </div>
                            <div class="flex justify-content-between mb-2 text-sm">
                                <span class="text-color-secondary">Discount:</span>
                                <span class="font-bold text-green-400">৳0.00</span>
                            </div>
                            <div class="flex justify-content-between mb-4 text-sm">
                                <span class="text-color-secondary">VAT (0%):</span>
                                <span class="font-bold text-white">৳0.00</span>
                            </div>
                            <div
                                class="flex justify-content-between align-items-center pt-4 border-top-1 border-white-alpha-10 mb-5">
                                <span class="font-bold text-xl text-white uppercase tracking-widest">GRAND TOTAL</span>
                                <span class="font-bold text-3xl text-primary">{{ orderTotal |
                                    currency:'BDT':'symbol-narrow' }}</span>
                            </div>
                            <div class="bg-primary-reverse-100 p-3 border-round-xl text-center">
                                <div class="text-xs text-color-secondary uppercase tracking-widest mb-1">Amount Due
                                </div>
                                <div class="text-2xl font-bold text-primary">{{ (orderPaymentMethod === 'Cash on
                                    Delivery' ? orderTotal : 0) | currency:'BDT':'symbol-narrow' }}</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Actions (Outside PDF area) -->
            <div class="flex flex-column gap-3 mt-5 px-3">
                <button pButton label="Download Receipt PDF" icon="pi pi-download"
                    class="premium-btn-primary p-button-lg w-full" (click)="downloadReceipt()"></button>

                <button pButton label="Continue Shopping" icon="pi pi-shopping-bag"
                    class="premium-btn-secondary p-button-lg w-full" (click)="continueShopping()"></button>
            </div>
        </div>

        <!-- Main Cart Content -->
        <div *ngIf="!orderConfirmed">

            <!-- Header -->
            <div class="cart-header flex justify-content-between align-items-center mb-5 fadein animation-duration-500">
                <h1 class="m-0 flex align-items-center gap-3 text-white">
                    <i class="pi pi-shopping-cart text-blue-400"></i>
                    Your Cart
                    <p-tag *ngIf="cartService.cart().length > 0" [value]="cartService.totalItems() + ' items'"
                        severity="info" [rounded]="true" styleClass="px-3"></p-tag>
                </h1>
                <button pButton label="Continue Shopping" icon="pi pi-arrow-left" class="premium-btn-secondary"
                    (click)="goBack()"></button>
            </div>

            <!-- Empty Cart -->
            <div *ngIf="cartService.cart().length === 0"
                class="empty-cart text-center py-8 fadein animation-duration-500">
                <div class="glass-card p-6 mx-auto" style="max-width: 500px;">
                    <i class="pi pi-shopping-cart text-6xl text-slate-500 mb-4 block"></i>
                    <h2 class="text-white mb-3">Your cart is empty</h2>
                    <p class="text-slate-400 mb-5 text-lg">Browse our products and add something you love!</p>
                    <button pButton label="Shop Now" icon="pi pi-shopping-bag" class="premium-btn-primary px-6"
                        (click)="goBack()"></button>
                </div>
            </div>

            <!-- Cart + Checkout -->
            <div *ngIf="cartService.cart().length > 0" class="grid fadein animation-duration-500">

                <!-- Left: Cart Items -->
                <div class="col-12 lg:col-7">
                    <div class="glass-card p-4 mb-4">
                        <h3 class="mt-0 mb-4 flex align-items-center gap-2 text-white">
                            <i class="pi pi-list text-blue-400"></i> Cart Items
                        </h3>

                        <div *ngFor="let item of cartService.cart(); let last = last"
                            class="cart-item-premium flex align-items-center gap-4 py-3" [class.border-bottom-1]="!last"
                            [class.border-white-alpha-10]="!last">
                            <img [src]="item.product.imageUrl" [alt]="item.product.name"
                                class="cart-item-image border-round-xl shadow-4" loading="lazy">

                            <div class="flex-grow-1">
                                <div class="font-bold text-lg mb-1">{{ item.product.name }}</div>
                                <div class="text-primary font-semibold">{{ item.product.price |
                                    currency:'BDT':'symbol-narrow' }}
                                </div>
                            </div>

                            <div class="flex align-items-center gap-2">
                                <button pButton icon="pi pi-minus"
                                    class="p-button-rounded p-button-outlined p-button-sm"
                                    (click)="updateQuantity(item, -1)"></button>
                                <span class="font-bold text-lg w-3rem text-center">{{ item.quantity }}</span>
                                <button pButton icon="pi pi-plus" class="p-button-rounded p-button-outlined p-button-sm"
                                    (click)="updateQuantity(item, 1)"></button>
                            </div>

                            <div class="text-right" style="min-width: 100px;">
                                <div class="font-bold text-lg">{{ item.product.price * item.quantity |
                                    currency:'BDT':'symbol-narrow' }}</div>
                            </div>

                            <button pButton icon="pi pi-trash"
                                class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                (click)="removeItem(item)"></button>
                        </div>

                        <!-- Price Summary -->
                        <div class="mt-4 pt-4 border-top-1 border-white-alpha-10">
                            <div class="flex justify-content-between mb-2">
                                <span class="text-slate-400">Subtotal</span>
                                <span class="font-semibold text-white">{{ getSubTotal() |
                                    currency:'BDT':'symbol-narrow'
                                    }}</span>
                            </div>
                            <div class="flex justify-content-between mb-2">
                                <span class="text-slate-400">Delivery Charge</span>
                                <span class="font-semibold text-white">{{ currentDeliveryCharge |
                                    currency:'BDT':'symbol-narrow'
                                    }}</span>
                            </div>
                            <div
                                class="flex justify-content-between mt-3 pt-3 border-top-1 border-white-alpha-10 text-xl">
                                <span class="font-bold text-white">Total</span>
                                <span class="font-bold text-blue-400">{{ getTotalPrice() |
                                    currency:'BDT':'symbol-narrow'
                                    }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Shipping + Payment -->
                    <div class="col-12 lg:col-5">

                        <!-- Shipping Form (hidden when payment section is shown) -->
                        <div *ngIf="!showPaymentSection" class="glass-card p-4 mb-4">
                            <h3 class="mt-0 mb-4 flex align-items-center gap-2 text-white">
                                <i class="pi pi-truck text-blue-400"></i> Shipping Details
                            </h3>

                            <div class="p-fluid">
                                <div class="field">
                                    <label for="cart_fullname" class="text-slate-400 font-medium">Full Name <span
                                            class="text-red-500">*</span></label>
                                    <input pInputText id="cart_fullname" [(ngModel)]="checkoutForm.fullName"
                                        placeholder="Enter your name" required #fullName="ngModel"
                                        class="w-full premium-input">
                                    <small class="p-error"
                                        *ngIf="fullName.invalid && (fullName.dirty || fullName.touched)">Full
                                        Name is
                                        required.</small>
                                </div>

                                <div class="field">
                                    <label for="cart_phone" class="text-slate-400 font-medium">Phone Number <span
                                            class="text-red-500">*</span></label>
                                    <input pInputText id="cart_phone" [(ngModel)]="checkoutForm.phoneNumber"
                                        placeholder="017..." maxlength="11" required #phone="ngModel"
                                        pattern="^(?:\+88|88)?(01[3-9]\d{8})$" class="w-full premium-input">
                                    <small class="p-error" *ngIf="phone.invalid && (phone.dirty || phone.touched)">Valid
                                        Phone Number is
                                        required.</small>
                                </div>

                                <div class="field">
                                    <label for="cart_email" class="text-slate-400 font-medium">Email Address <span
                                            class="text-xs text-slate-500 ml-1">(Optional)</span></label>
                                    <input pInputText id="cart_email" [(ngModel)]="checkoutForm.email"
                                        placeholder="Enter your email" #email="ngModel" [pattern]="emailRegex"
                                        class="w-full premium-input">
                                    <small class="p-error"
                                        *ngIf="email.invalid && (email.dirty || email.touched)">Please
                                        enter a valid email address.</small>
                                </div>

                                <div class="formgrid grid">
                                    <div class="field col-6">
                                        <label for="cart_district" class="text-slate-400 font-medium">District <span
                                                class="text-red-500">*</span></label>
                                        <p-dropdown inputId="cart_district" [options]="districts" optionLabel="name"
                                            optionValue="name" [(ngModel)]="checkoutForm.district"
                                            (onChange)="onDistrictChange($event)" placeholder="Select District"
                                            appendTo="body" required #district="ngModel"
                                            styleClass="w-full premium-dropdown" [style]="{'width':'100%'}"
                                            [filter]="true" filterBy="name"></p-dropdown>
                                        <small class="p-error"
                                            *ngIf="district.invalid && (district.dirty || district.touched)">District is
                                            required.</small>
                                    </div>
                                    <div class="field col-6">
                                        <label class="text-slate-400 font-medium">Sub-District <span
                                                class="text-red-500" *ngIf="subDistricts.length > 0">*</span></label>
                                        <p-dropdown [options]="subDistricts" [(ngModel)]="checkoutForm.subDistrict"
                                            placeholder="Select Thana" [disabled]="!subDistricts.length" appendTo="body"
                                            [required]="subDistricts.length > 0" styleClass="w-full premium-dropdown"
                                            [style]="{'width':'100%'}" [filter]="true"></p-dropdown>
                                    </div>
                                </div>

                                <div class="field">
                                    <label for="cart_postal" class="text-slate-400 font-medium">Postal Code <span
                                            class="text-xs text-slate-500 ml-1">(Optional)</span></label>
                                    <input pInputText id="cart_postal" [(ngModel)]="checkoutForm.postalCode"
                                        placeholder="Enter 4-digit postal code" maxlength="4" #postal="ngModel"
                                        [pattern]="postalCodeRegex" class="w-full premium-input">
                                    <small class="p-error"
                                        *ngIf="postal.invalid && (postal.dirty || postal.touched)">Postal
                                        code must be 4 digits.</small>
                                </div>

                                <div class="field">
                                    <label for="cart_address" class="text-slate-400 font-medium">Full Address <span
                                            class="text-red-500">*</span></label>
                                    <textarea pInputTextarea id="cart_address" [(ngModel)]="checkoutForm.fullAddress"
                                        rows="2" placeholder="House, Road, Area..." required #address="ngModel"
                                        class="w-full premium-input"></textarea>
                                    <small class="p-error"
                                        *ngIf="address.invalid && (address.dirty || address.touched)">Full
                                        Address is
                                        required.</small>
                                </div>

                                <button pButton label="Proceed to Payment" icon="pi pi-arrow-right"
                                    class="premium-btn-primary w-full mt-3" (click)="proceedToPayment()"
                                    [loading]="loading()" *ngIf="!showPaymentSection"></button>
                            </div>
                        </div>

                        <!-- Payment Section (shown after form validation, replaces shipping form) -->
                        <div *ngIf="showPaymentSection" id="payment-section" class="glass-card p-4 payment-appear">

                            <!-- Shipping Summary -->
                            <div class="bg-white-alpha-5 border-round-xl p-3 mb-4 border-1 border-white-alpha-10">
                                <div class="flex justify-content-between align-items-center mb-2">
                                    <span class="font-bold text-white flex align-items-center gap-2">
                                        <i class="pi pi-truck text-blue-400"></i> Shipping To
                                    </span>
                                    <button pButton label="Edit" icon="pi pi-pencil"
                                        class="p-button-text p-button-sm text-blue-400"
                                        (click)="showPaymentSection = false"></button>
                                </div>
                                <div class="text-slate-400 text-sm line-height-3">
                                    <div class="text-white font-medium">{{ checkoutForm.fullName }} &bull; {{
                                        checkoutForm.phoneNumber }}</div>
                                    <div>{{ checkoutForm.fullAddress }}, {{ checkoutForm.subDistrict ?
                                        checkoutForm.subDistrict + ', ' : '' }}{{ checkoutForm.district }}</div>
                                </div>
                            </div>

                            <h3 class="mt-0 mb-4 flex align-items-center gap-2 text-white">
                                <i class="pi pi-wallet text-blue-400"></i> Payment Method
                            </h3>

                            <div class="grid mb-4">
                                <div class="col-6">
                                    <div class="payment-method-card flex flex-column align-items-center justify-content-center gap-3"
                                        [class.active]="selectedPaymentMethod === 'COD'"
                                        (click)="selectedPaymentMethod = 'COD'">
                                        <div class="bg-primary-reverse-100 p-3 border-circle">
                                            <i class="pi pi-money-bill text-3xl text-primary"></i>
                                        </div>
                                        <div class="font-bold text-color">Cash on Delivery</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="payment-method-card flex flex-column align-items-center justify-content-center gap-3"
                                        [class.active]="selectedPaymentMethod === 'bKash'"
                                        (click)="selectedPaymentMethod = 'bKash'">
                                        <div class="bg-pink-900/20 p-3 border-circle">
                                            <img src="assets/bkash-logo.png" alt="bKash" height="30" loading="lazy">
                                        </div>
                                        <div class="font-bold text-color">bKash Payment</div>
                                    </div>
                                </div>
                            </div>

                            <!-- bKash Details -->
                            <div *ngIf="selectedPaymentMethod === 'bKash'"
                                class="payment-appear p-4 border-round-xl surface-ground border-1 surface-border">
                                <div class="text-center mb-4">
                                    <div
                                        class="inline-flex align-items-center justify-content-center surface-100 px-3 py-1 border-round-pill mb-3">
                                        <span class="text-pink-400 font-bold text-sm">Scan to Pay</span>
                                    </div>
                                    <img src="assets/bkash-qr.png" alt="bKash QR" width="160"
                                        class="border-round shadow-2 block mx-auto bg-white p-2" loading="lazy">
                                </div>

                                <div class="p-fluid">
                                    <div class="field mb-4">
                                        <label class="font-bold text-color block mb-2">Your bKash Number</label>
                                        <input pInputText [(ngModel)]="bkashPhone" placeholder="017XXXXXXXX"
                                            maxlength="11" class="w-full py-3">
                                    </div>
                                    <div class="field mb-4">
                                        <label class="font-bold text-color block mb-2">Transaction ID</label>
                                        <input pInputText [(ngModel)]="bkashTrxId" placeholder="Enter 10-digit ID"
                                            class="w-full py-3">
                                    </div>
                                    <button pButton label="Complete Payment" icon="pi pi-shield"
                                        class="p-button-danger p-button-lg w-full" (click)="submitBkashPayment()"
                                        [disabled]="!bkashPhone || !bkashTrxId" [loading]="loading()"></button>
                                </div>
                            </div>

                            <!-- COD Confirm -->
                            <div *ngIf="selectedPaymentMethod === 'COD'" class="payment-appear">
                                <div
                                    class="surface-ground p-3 border-round-lg mb-4 text-center border-1 surface-border">
                                    <p class="text-color-secondary m-0">You will pay the total amount to the delivery
                                        person
                                        when your
                                        package arrives.</p>
                                </div>
                                <button pButton label="Confirm COD Order" icon="pi pi-check" class="p-button-lg w-full"
                                    (click)="confirmCOD()" [loading]="loading()"></button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>