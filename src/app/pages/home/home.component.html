<!-- ... existing content ... -->
<div class="home-container">
    <!-- Hero Section -->
    <div class="hero-section relative h-30rem flex align-items-center justify-content-center text-center text-white mb-5"
        [style.background-image]="'linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url(' + landingPageImage() + ')'"
        style="background-size: cover; background-position: center;">
        <div class="z-1">
            <h1 class="text-6xl font-bold mb-2">Karukolpo</h1>
            <p class="text-2xl">{{ landingPageTagline() }}</p>
            <div class="flex gap-3 justify-content-center mt-4">
                <button pButton label="Shop Now" icon="pi pi-shopping-bag" class="p-button-lg"
                    (click)="scrollToProducts()"></button>
                <button pButton label="Track Order" icon="pi pi-search" class="p-button-lg p-button-outlined text-white"
                    (click)="displayTrackOrderModal = true"></button>
            </div>
        </div>
    </div>

    <!-- Category Filter -->
    <div class="container mb-4 px-4">
        <div class="flex flex-wrap justify-content-center gap-2">
            <button pButton [label]="'All'" [class.p-button-outlined]="selectedCategory !== null"
                (click)="selectCategory(null)" class="p-button-rounded p-button-sm"></button>
            <button *ngFor="let cat of categories()" pButton [label]="cat.name"
                [class.p-button-outlined]="selectedCategory?.id !== cat.id" (click)="selectCategory(cat)"
                class="p-button-rounded p-button-sm"></button>
        </div>
    </div>

    <!-- Products Grid -->
    <div id="products" class="container px-4 pb-8">
        <div *ngIf="loading()" class="grid">
            <div class="col-12 sm:col-6 md:col-4 lg:col-3" *ngFor="let i of [1,2,3,4]">
                <div class="p-4 border-1 surface-border surface-card border-round">
                    <p-skeleton width="100%" height="200px" styleClass="mb-2"></p-skeleton>
                    <p-skeleton width="50%" styleClass="mb-2"></p-skeleton>
                    <p-skeleton width="25%" styleClass="mb-2"></p-skeleton>
                </div>
            </div>
        </div>

        <div class="grid" *ngIf="!loading()">
            <div class="col-12 sm:col-6 md:col-4 lg:col-3" *ngFor="let product of filteredProducts()">
                <div class="product-card surface-card border-round shadow-2 p-3 h-full flex flex-column relative">
                    <!-- Out of Stock Overlay -->
                    <div *ngIf="isOutOfStock(product)"
                        class="absolute top-0 left-0 w-full h-full bg-black-alpha-50 z-1 flex align-items-center justify-content-center border-round">
                        <span class="bg-red-500 text-white px-3 py-1 border-round font-bold">Out of Stock</span>
                    </div>

                    <div class="relative mb-3 cursor-pointer" (click)="showProductDetails(product)">
                        <img [src]="product.imageUrl" [alt]="product.name" class="w-full border-round"
                            style="height: 200px; object-fit: cover;">
                    </div>
                    <div class="flex-grow-1">
                        <div class="text-xl font-bold mb-2">{{ product.name }}</div>
                        <div class="text-600 mb-3 line-clamp-2">{{ product.description }}</div>
                        <div class="text-primary text-xl font-bold">{{ product.price | currency:'BDT':'symbol-narrow' }}
                        </div>
                    </div>
                    <div class="mt-3">
                        <button pButton label="Add to Cart" icon="pi pi-shopping-cart" class="w-full"
                            [disabled]="isOutOfStock(product)" (click)="addToCart(product)"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Cart Button -->
    <button pButton class="fixed bottom-0 right-0 m-4 p-button-rounded p-button-lg shadow-4 z-5 overflow-visible"
        (click)="openCheckout()">
        <i class="pi pi-shopping-cart text-xl" pBadge [value]="getTotalCartItems().toString()" severity="danger"
            [badgeDisabled]="getTotalCartItems() === 0"></i>
    </button>
</div>

<!-- Product Details Modal -->
<p-dialog [(visible)]="displayProductModal" [modal]="true" [style]="{width: '90vw', maxWidth: '800px'}"
    [header]="selectedProduct?.name || 'Product Details'" [dismissableMask]="true">
    <div class="grid" *ngIf="selectedProduct">
        <div class="col-12 md:col-6">
            <p-galleria
                [value]="selectedProduct.images && selectedProduct.images.length > 0 ? selectedProduct.images : [selectedProduct.imageUrl]"
                [numVisible]="5" [circular]="true" [showItemNavigators]="true"
                [showThumbnails]="selectedProduct.images && selectedProduct.images.length > 1"
                [responsiveOptions]="responsiveOptions" [containerStyle]="{'max-width': '100%'}">
                <ng-template pTemplate="item" let-item>
                    <img [src]="item" style="width: 100%; display: block; max-height: 400px; object-fit: contain;" />
                </ng-template>
                <ng-template pTemplate="thumbnail" let-item>
                    <div class="grid grid-nogutter justify-content-center">
                        <img [src]="item" style="display: block; width: 50px; height: 50px; object-fit: cover;" />
                    </div>
                </ng-template>
            </p-galleria>
        </div>
        <div class="col-12 md:col-6">
            <div class="text-3xl font-bold mb-3">{{ selectedProduct.name }}</div>
            <div class="text-2xl text-primary font-bold mb-4">{{ selectedProduct.price |
                currency:'BDT':'symbol-narrow' }}</div>
            <p class="line-height-3 text-700 mb-4">{{ selectedProduct.description }}</p>

            <div class="mb-4" *ngIf="selectedProduct.stock !== undefined">
                <span [class]="isOutOfStock(selectedProduct) ? 'text-red-500' : 'text-green-500'">
                    <i class="pi" [class]="isOutOfStock(selectedProduct) ? 'pi-times-circle' : 'pi-check-circle'"></i>
                    {{ isOutOfStock(selectedProduct) ? 'Out of Stock' : (selectedProduct.stock + ' items in stock') }}
                </span>
            </div>

            <button pButton label="Add to Cart" icon="pi pi-shopping-cart" class="p-button-lg w-full"
                [disabled]="isOutOfStock(selectedProduct)" (click)="addToCart(selectedProduct)"></button>
        </div>
    </div>
</p-dialog>

<!-- Checkout Modal (Step 1: Shipping) -->
<p-dialog [(visible)]="displayCheckoutModal" [modal]="true" [style]="{width: '90vw', maxWidth: '600px'}"
    header="Checkout" [dismissableMask]="false">
    <div class="grid">
        <!-- Cart Summary -->
        <div class="col-12 mb-4">
            <div class="surface-card p-3 border-round shadow-1">
                <div *ngFor="let item of cart()"
                    class="flex align-items-center justify-content-between mb-3 border-bottom-1 surface-border pb-2">
                    <div class="flex align-items-center gap-3">
                        <img [src]="item.product.imageUrl" class="w-3rem h-3rem border-round object-cover">
                        <div>
                            <div class="font-bold">{{ item.product.name }}</div>
                            <div class="text-sm text-600">{{ item.product.price | currency:'BDT':'symbol-narrow' }} x {{
                                item.quantity }}</div>
                        </div>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <button pButton icon="pi pi-minus" class="p-button-rounded p-button-text p-button-sm"
                            (click)="updateQuantity(item, -1)"></button>
                        <span class="font-bold w-2rem text-center">{{ item.quantity }}</span>
                        <button pButton icon="pi pi-plus" class="p-button-rounded p-button-text p-button-sm"
                            (click)="updateQuantity(item, 1)"></button>
                    </div>
                </div>
                <div class="flex justify-content-between mt-3">
                    <span>Subtotal</span>
                    <span class="font-bold">{{ getSubTotal() | currency:'BDT':'symbol-narrow' }}</span>
                </div>
                <div class="flex justify-content-between mt-2">
                    <span>Delivery Charge</span>
                    <span class="font-bold">{{ currentDeliveryCharge | currency:'BDT':'symbol-narrow' }}</span>
                </div>
                <div class="flex justify-content-between mt-3 pt-3 border-top-1 surface-border text-xl font-bold">
                    <span>Total</span>
                    <span class="text-primary">{{ getTotalPrice() | currency:'BDT':'symbol-narrow' }}</span>
                </div>
            </div>
        </div>

        <!-- Shipping Form -->
        <div class="col-12">
            <div class="p-fluid">
                <div class="field">
                    <label>Full Name <span class="text-red-500">*</span></label>
                    <input pInputText [(ngModel)]="checkoutForm.fullName" placeholder="Enter your name" required
                        class="w-full" #fullName="ngModel">
                    <small class="p-error" *ngIf="fullName.invalid && (fullName.dirty || fullName.touched)">Full Name is
                        required.</small>
                </div>
                <div class="field">
                    <label>Phone Number <span class="text-red-500">*</span></label>
                    <input pInputText [(ngModel)]="checkoutForm.phoneNumber" placeholder="017..." maxlength="11"
                        required #phone="ngModel" pattern="^(?:\+88|88)?(01[3-9]\d{8})$" class="w-full">
                    <small class="p-error" *ngIf="phone.invalid && (phone.dirty || phone.touched)">Valid Phone Number is
                        required.</small>
                </div>
                <div class="field">
                    <label>Email <span class="text-red-500">*</span></label>
                    <input pInputText [(ngModel)]="checkoutForm.email" placeholder="example@email.com" required email
                        class="w-full" #email="ngModel">
                    <small class="p-error" *ngIf="email.invalid && (email.dirty || email.touched)">Valid Email is
                        required.</small>
                </div>

                <div class="field">
                    <label>Delivery Location</label>
                    <div class="flex gap-3">
                        <div class="flex align-items-center">
                            <p-radioButton name="delivery" value="Inside Dhaka" [(ngModel)]="deliveryLocation"
                                (onClick)="updateDeliveryCharge()"></p-radioButton>
                            <label class="ml-2">Inside Dhaka</label>
                        </div>
                        <div class="flex align-items-center">
                            <p-radioButton name="delivery" value="Outside Dhaka" [(ngModel)]="deliveryLocation"
                                (onClick)="updateDeliveryCharge()"></p-radioButton>
                            <label class="ml-2">Outside Dhaka</label>
                        </div>
                    </div>
                </div>

                <div class="formgrid grid">
                    <div class="field col-6">
                        <label>District <span class="text-red-500">*</span></label>
                        <p-dropdown [options]="districts" optionLabel="name" optionValue="name"
                            [(ngModel)]="checkoutForm.district" (onChange)="onDistrictChange($event)"
                            placeholder="Select District" appendTo="body" required #district="ngModel"
                            styleClass="w-full" [style]="{'width':'100%'}"></p-dropdown>
                        <small class="p-error" *ngIf="district.invalid && (district.dirty || district.touched)">District
                            is required.</small>
                    </div>
                    <div class="field col-6">
                        <label>Sub-District <span class="text-red-500" *ngIf="subDistricts.length > 0">*</span></label>
                        <p-dropdown [options]="subDistricts" [(ngModel)]="checkoutForm.subDistrict"
                            placeholder="Select Thana" [disabled]="!subDistricts.length" appendTo="body"
                            [required]="subDistricts.length > 0" styleClass="w-full"
                            [style]="{'width':'100%'}"></p-dropdown>
                    </div>
                </div>
                <div class="field">
                    <label>Postal Code <span class="text-red-500">*</span></label>
                    <input pInputText [(ngModel)]="checkoutForm.postalCode" placeholder="1234" maxlength="4" required
                        pattern="\d{4}" #postal="ngModel" class="w-full">
                    <small class="p-error" *ngIf="postal.invalid && (postal.dirty || postal.touched)">Valid Postal Code
                        is required.</small>
                </div>
                <div class="field">
                    <label>Full Address <span class="text-red-500">*</span></label>
                    <textarea pInputTextarea [(ngModel)]="checkoutForm.fullAddress" rows="2"
                        placeholder="House, Road, Area..." required #address="ngModel" class="w-full"></textarea>
                    <small class="p-error" *ngIf="address.invalid && (address.dirty || address.touched)">Full Address is
                        required.</small>
                </div>

                <button pButton label="Place Order" class="w-full p-button-lg mt-4" [disabled]="!isCheckoutFormValid"
                    (click)="placeOrder()"></button>
            </div>
        </div>
    </div>
</p-dialog>

<!-- Track Order Modal -->
<p-dialog [(visible)]="displayTrackOrderModal" [modal]="true" [style]="{width: '90vw', maxWidth: '600px'}"
    header="Track Order">
    <div class="p-fluid">
        <div class="field">
            <label>Enter Phone Number</label>
            <div class="flex gap-3 w-full">
                <input pInputText [(ngModel)]="trackPhone" placeholder="017..." (keyup.enter)="trackOrder()"
                    class="flex-1">
                <button pButton icon="pi pi-search" (click)="trackOrder()" [loading]="trackingLoading"></button>
            </div>
        </div>

        <div *ngIf="trackedOrders.length > 0" class="mt-4">
            <div *ngFor="let order of trackedOrders" class="surface-card p-3 border-round shadow-1 mb-3">
                <div class="flex justify-content-between align-items-center mb-2">
                    <span class="font-bold">Order #{{ order.id }}</span>
                    <p-tag [value]="order.status"
                        [severity]="order.status === 'Confirmed' ? 'success' : 'warning'"></p-tag>
                </div>
                <div class="text-sm text-600 mb-2">
                    {{ order.orderDate | date:'medium' }}
                </div>
                <div class="flex justify-content-between align-items-center">
                    <span class="font-bold text-primary">{{ order.totalAmount | currency:'BDT':'symbol-narrow' }}</span>

                    <!-- Payment Button -->
                    <button pButton label="Make Payment" icon="pi pi-wallet" class="p-button-sm"
                        *ngIf="order.status === 'Confirmed' && order.paymentStatus !== 'Paid'"
                        (click)="openPaymentForOrder(order.id)"></button>

                    <p-tag *ngIf="order.paymentStatus === 'Paid'" value="Paid" severity="success"></p-tag>
                    <p-tag *ngIf="order.status !== 'Confirmed' && order.paymentStatus !== 'Paid'"
                        value="Waiting Approval" severity="info"></p-tag>
                </div>
            </div>
        </div>

        <div *ngIf="trackPhone && trackedOrders.length === 0 && !trackingLoading && hasSearched"
            class="text-center mt-4 text-600">
            No orders found for this phone number.
        </div>
    </div>
</p-dialog>

<!-- Payment Method Modal (Step 2) -->
<p-dialog [(visible)]="displayPaymentMethodModal" [modal]="true" [style]="{width: '90vw', maxWidth: '500px'}"
    header="Select Payment Method" [closable]="true">
    <div class="p-fluid">
        <p class="mb-4 text-center">Payment for Order #{{ placedOrderId }}</p>

        <div class="grid">
            <div class="col-6">
                <div class="p-3 border-1 border-round cursor-pointer transition-colors transition-duration-200 flex flex-column align-items-center gap-2 h-full"
                    [class.border-primary]="selectedPaymentMethod === 'bKash'"
                    [class.surface-50]="selectedPaymentMethod !== 'bKash'"
                    [class.bg-blue-50]="selectedPaymentMethod === 'bKash'" (click)="selectPaymentMethod('bKash')">
                    <img src="assets/bkash-logo.png" alt="bKash" height="40">
                    <span class="font-bold">bKash Payment</span>
                </div>
            </div>
            <div class="col-6">
                <div class="p-3 border-1 border-round cursor-pointer transition-colors transition-duration-200 flex flex-column align-items-center gap-2 h-full"
                    [class.border-primary]="selectedPaymentMethod === 'COD'"
                    [class.surface-50]="selectedPaymentMethod !== 'COD'"
                    [class.bg-blue-50]="selectedPaymentMethod === 'COD'" (click)="selectPaymentMethod('COD')">
                    <i class="pi pi-money-bill text-4xl text-green-600"></i>
                    <span class="font-bold">Cash On Delivery</span>
                </div>
            </div>
        </div>

        <!-- bKash Details -->
        <div *ngIf="selectedPaymentMethod === 'bKash'" class="field mt-4 surface-ground p-3 border-round">
            <div class="text-center mb-3" *ngIf="bkashQrCodeInModal">
                <p class="mb-2 font-bold">Scan to Pay</p>
                <img [src]="bkashQrCodeInModal" alt="bKash QR" width="150" class="border-round shadow-2">
            </div>

            <label class="mt-3 block">Transaction ID</label>
            <input pInputText [(ngModel)]="transactionId" placeholder="e.g. 9G7...">
        </div>

        <button pButton label="Confirm Payment" class="w-full mt-4"
            [disabled]="!selectedPaymentMethod || (selectedPaymentMethod === 'bKash' && !transactionId)"
            (click)="processPayment()"></button>
    </div>
</p-dialog>

<!-- Order Success Modal (Waiting for Approval) -->
<p-dialog [(visible)]="displayOrderSuccessModal" [modal]="true" [style]="{width: '400px'}" header="Order Placed!"
    [closable]="true">
    <div class="flex flex-column align-items-center text-center">
        <i class="pi pi-clock text-6xl text-orange-500 mb-3"></i>
        <h2 class="m-0 mb-2">Waiting for Approval</h2>
        <p class="text-600 mb-4">Your order has been placed and is waiting for admin approval.</p>

        <div class="surface-ground p-3 border-round w-full mb-4">
            <div class="text-sm text-600 mb-1">Order ID</div>
            <div class="text-xl font-bold text-primary">{{ placedOrderId }}</div>
            <div class="mt-3 bg-white p-2 border-round">
                <svg id="barcode"></svg>
            </div>
        </div>

        <p class="text-sm text-600 mb-4">Once approved, you can track your order and make payment.</p>
        <button pButton label="Continue Shopping" (click)="displayOrderSuccessModal = false"></button>
    </div>
</p-dialog>

<!-- Payment Submitted Modal -->
<p-dialog [(visible)]="displayPaymentSuccessModal" [modal]="true" [style]="{width: '400px'}" header="Payment Submitted"
    [closable]="true">
    <div class="flex flex-column align-items-center text-center">
        <i class="pi pi-check-circle text-6xl text-green-500 mb-3"></i>
        <h2 class="m-0 mb-2">Payment Submitted</h2>
        <p class="text-600 mb-4" *ngIf="selectedPaymentMethod === 'bKash'">Your bKash payment is waiting for
            verification.</p>
        <p class="text-600 mb-4" *ngIf="selectedPaymentMethod === 'COD'">Your Cash on Delivery request has been
            recorded.</p>
        <button pButton label="Close" (click)="displayPaymentSuccessModal = false"></button>
    </div>
</p-dialog>

<p-toast></p-toast>